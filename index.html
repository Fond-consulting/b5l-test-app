<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Test de Personalidad B5L</title>

  <!-- Google Fonts: AHORA SÓLO CARGAMOS INTER -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --clr-primary: #222c45;
      --clr-accent-from: #70b37d;
      --clr-accent-to: #9dd0a4;
      --clr-surface: #ffffff;
      --clr-scale-bg: #f0f4f8;
      --clr-scale-hover: #e5edf0;
      --clr-border: #d0d5dd;
      --radius: .75rem;
      /* La fuente principal ahora es Inter */
      --font-main: "Inter", sans-serif;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html{height:100%;}
    body{
      /* APLICAMOS INTER A TODO EL DOCUMENTO */
      font-family: var(--font-main);
      color:var(--clr-primary);
      background:var(--clr-surface);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content: center;
      padding: 3rem 1rem 6rem;
      min-height: 100%;
    }
    
    #start-screen, #test-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 900px;
    }

    #start-screen h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 2rem;
    }
    #start-screen p {
        font-size: 1.1rem;
        line-height: 1.6;
        text-align: center;
        max-width: 650px;
        margin-bottom: 1rem;
        font-weight: 400; /* Peso Regular para los párrafos */
    }
    #start-btn {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--clr-surface);
        background-color: var(--clr-accent-from);
        border: none;
        border-radius: var(--radius);
        padding: 0.8rem 2.5rem;
        cursor: pointer;
        margin-top: 2rem;
        transition: background-color .2s;
        font-family: var(--font-main); /* Aseguramos herencia */
    }
    #start-btn:hover {
        background-color: #63a270;
    }

    #question-text{
      font-size:2rem;
      font-weight:700;
      line-height:1.3;
      text-align:center;
      margin-inline:auto;
      margin-bottom:3rem;
    }
    .scale{
      display:flex;
      flex-direction:column;
      gap:1.25rem;
      width:100%;
      max-width:620px;
    }
    .answer-btn{
      width:100%;
      padding:1.125rem 1.25rem;
      font-size:1.05rem;
      font-weight:500;
      border-radius:var(--radius);
      background:var(--clr-scale-bg);
      border:none;
      cursor:pointer;
      text-align: center;
      transition:background .25s, transform .1s;
      color: var(--clr-primary);
      font-family: var(--font-main); /* Aseguramos herencia */
    }
    .answer-btn:hover:not(:disabled) {
      background:var(--clr-scale-hover);
    }
    .answer-btn:active:not(:disabled) {
      transform: scale(0.99);
    }
    .answer-btn.selected {
        background-color: #d1e9d6;
        font-weight: 600;
    }
    
    footer{
      position:fixed;
      left:0;
      bottom:0;
      width:100%;
      background:var(--clr-surface);
      border-top:1px solid var(--clr-border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:.75rem 1rem;
    }
    #prev-btn{
      width:42px;
      height:42px;
      border:1px solid var(--clr-border);
      border-radius:8px;
      background:var(--clr-surface);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:background .25s;
    }
    #prev-btn svg{stroke:var(--clr-primary);transition:stroke .25s;width:16px;height:16px;}
    #prev-btn:hover:not(:disabled){background:#f5f7f8;}
    #prev-btn:disabled{opacity:.4;cursor:not-allowed;}
    .progress-wrapper{
      flex:1;
      height:4px;
      background:#e5e7eb;
      border-radius:2px;
      margin:0 1rem;
      overflow:hidden;
    }
    #progress-bar{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,var(--clr-accent-from) 0%,var(--clr-accent-to) 100%);
      transition:width .3s ease;
    }
    .powered{
      font-size:.8rem;
      display:flex;
      align-items:center;
      gap:.6rem;
      color:#6b7280;
    }
    .powered img{height:22px;}

    @media (max-width: 600px) {
      body {
        justify-content: flex-start;
        padding-top: 5rem;
      }
      #start-screen h1 { font-size: 2rem; }
      #start-screen p { font-size: 1rem; }
      .powered img { height: 18px; }
    }
  </style>
</head>
<body>

  <div id="start-screen">
      <h1>Vamos a empezar...</h1>
      <p>Lee cuidadosamente cada una de las afirmaciones y selecciona la opción que mejor exprese tu grado de acuerdo (falso o cierto para ti). No hay respuestas correctas o incorrectas, cada persona es diferente. Responde de la manera que mejor te describa a ti mismo.</p>
      <p>Este test no tiene límite de tiempo, pero intenta contestar sin entretenerte demasiado.</p>
      <p>La primera impresión suele ser la más acertada. No dejes respuestas en blanco.</p>
      <p>Recuerda, si necesitas una pausa, cierra el navegador y cuando vuelvas a entrar, continuarás donde lo dejaste.</p>
      <button id="start-btn">Empezar</button>
  </div>

  <div id="test-container" style="display: none;">
      <h2 id="question-text">Cargando preguntas...</h2>
      <div class="scale" id="scale-container"></div>
  </div>

  <footer style="display: none;">
    <button id="prev-btn" aria-label="Pregunta anterior" disabled>
      <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
    </button>
    <div class="progress-wrapper"><div id="progress-bar" style="width: 0%;"></div></div>
    <div class="powered">
      powered by <img src="Logotipo_Smartest_H_color.png" alt="SMARTTEST logo" />
    </div>
  </footer>

  <script>
    const startScreen = document.getElementById('start-screen');
    const testContainer = document.getElementById('test-container');
    const startBtn = document.getElementById('start-btn');
    const qText = document.getElementById('question-text');
    const scaleContainer = document.getElementById('scale-container');
    const prevBtn = document.getElementById('prev-btn');
    const progressBar = document.getElementById('progress-bar');
    const footer = document.querySelector('footer');

    let questionOrder = [];
    let currentQuestionIndex = 0;
    let userAnswers = {};  // {item_id: selectedText}
    let itemsData = [];
    let responseOptions = [];
    let baremosFacetas = [];
    let baremosDeseabilidad = [];
    let baremosDimensiones = [];
    let sexo = 'H'; // Simulado; real de Bubble.
    let edad = 35; // Simulado.

    async function loadCSVs() {
      const itemsRaw = await loadCSV('B5L - Datos Maestros (Gemini) - Items.csv');
      itemsData = itemsRaw.slice(1).map(row => ({
        item_id: row[0],
        texto: row[1],
        codigo_faceta: row[2],
        tipo_puntuacion: row[3]
      }));

      const reglasRaw = await loadCSV('B5L - Datos Maestros (Gemini) - Puntuacion_Respuestas.csv');
      responseOptions = reglasRaw.slice(1).map(row => ({
        text: row[0],
        directa: parseInt(row[1]),
        inversa: parseInt(row[2]),
        dsdt: parseInt(row[3])
      }));

      const facetasRaw = await loadCSV('B5L - Datos Maestros (Gemini) - Baremos_Facetas.csv');
      baremosFacetas = facetasRaw.slice(1).map(row => ({
        codigo_faceta: row[0],
        sexo: row[1],
        edad_desde: parseInt(row[2]),
        edad_hasta: parseInt(row[3]),
        pd_desde: parseInt(row[4]),
        pd_hasta: parseInt(row[5]),
        percentil: parseInt(row[6])
      }));

      const deseabilidadRaw = await loadCSV('B5L - Datos Maestros (Gemini) - Baremos_Deseabilidad.csv');
      baremosDeseabilidad = deseabilidadRaw.slice(1).map(row => ({
        codigo_faceta: row[0],
        sexo: row[1],
        edad_desde: parseInt(row[2]),
        edad_hasta: parseInt(row[3]),
        pd_desde: parseInt(row[4]),
        pd_hasta: parseInt(row[5]),
        percentil: parseInt(row[6])
      }));

      const dimensionesRaw = await loadCSV('B5L - Datos Maestros (Gemini) - Baremos_Dimensiones.csv');
      baremosDimensiones = dimensionesRaw.slice(1).map(row => ({
        codigo_dimension: row[0],
        sexo: row[1],
        edad_desde: parseInt(row[2]),
        edad_hasta: parseInt(row[3]),
        pd_desde: parseInt(row[4]),
        pd_hasta: parseInt(row[5]),
        percentil: parseInt(row[6])
      }));
    }

    async function loadCSV(file) {
      const response = await fetch(file);
      const text = await response.text();
      return text.trim().split('\n').map(row => row.split(','));
    }

    async function startTest() {
      await loadCSVs();
      startScreen.style.display = 'none';
      testContainer.style.display = 'flex';
      footer.style.display = 'flex';
      questionOrder = shuffleQuestions();
      renderQuestion();
    }

    function shuffleQuestions() {
      const itemsByFacet = itemsData.reduce((acc, item) => {
        const faceta = item.codigo_faceta;
        if (!acc[faceta]) acc[faceta] = [];
        acc[faceta].push(item);
        return acc;
      }, {});
      const shuffledFacetKeys = Object.keys(itemsByFacet).sort(() => Math.random() - 0.5); // Random but fixed per load; for true fixed, sort alphabetically: .sort()
      const maxItems = Math.max(...Object.values(itemsByFacet).map(arr => arr.length));
      const shuffled = [];
      for (let i = 0; i < maxItems; i++) {
        for (const key of shuffledFacetKeys) {
          if (itemsByFacet[key][i]) shuffled.push(itemsByFacet[key][i]);
        }
      }
      return shuffled;
    }

    function renderQuestion() {
      const totalQuestions = questionOrder.length;
      const item = questionOrder[currentQuestionIndex];
      qText.textContent = item.texto;
      const answeredCount = Object.keys(userAnswers).length;
      progressBar.style.width = `${(answeredCount / totalQuestions) * 100}%`;
      scaleContainer.innerHTML = '';
      responseOptions.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'answer-btn';
        btn.textContent = opt.text;
        if (userAnswers[item.item_id] === opt.text) {
          btn.classList.add('selected');
        }
        btn.onclick = (event) => {
          userAnswers[item.item_id] = opt.text;
          scaleContainer.style.pointerEvents = 'none';
          const allButtons = scaleContainer.querySelectorAll('.answer-btn');
          allButtons.forEach(b => b.classList.remove('selected'));
          event.currentTarget.classList.add('selected');
          setTimeout(() => {
            if (currentQuestionIndex < totalQuestions - 1) {
              currentQuestionIndex++;
              renderQuestion();
            } else {
              progressBar.style.width = '100%';
              calculateAndShowResults();
            }
            scaleContainer.style.pointerEvents = 'auto';
          }, 340);
        };
        scaleContainer.appendChild(btn);
      });
      prevBtn.disabled = currentQuestionIndex === 0;
    }

    function calculateAndShowResults() {
      const pdFacetas = {};
      questionOrder.forEach(item => {
        const selectedText = userAnswers[item.item_id];
        if (selectedText) {
          const faceta = item.codigo_faceta;
          if (!pdFacetas[faceta]) pdFacetas[faceta] = 0;
          const opt = responseOptions.find(o => o.text === selectedText);
          let score = 0;
          if (faceta === 'DSDT') {
            score = opt.dsdt;
          } else {
            score = item.tipo_puntuacion.includes('INV') ? opt.inversa : opt.directa;
          }
          pdFacetas[faceta] += score;
        }
      });

      const resultadosFacetas = {};
      for (const [faceta, pd] of Object.entries(pdFacetas)) {
        const baremoList = faceta === 'DSDT' ? baremosDeseabilidad : baremosFacetas;
        const baremo = baremoList.find(b => b.codigo_faceta === faceta && b.sexo === sexo && b.edad_desde <= edad && b.edad_hasta >= edad && b.pd_desde <= pd && b.pd_hasta >= pd);
        const percentil = baremo ? baremo.percentil : 'No encontrado';
        resultadosFacetas[faceta] = { PD: pd, Percentil: percentil };
      }

      const mapaDimensiones = {
        'E': ['F1E', 'F2E', 'F3E', 'F4E', 'F5E', 'F6E'],
        'C': ['F1C', 'F2C', 'F3C', 'F4C', 'F5C', 'F6C'],
        'R': ['F1R', 'F2R', 'F3R', 'F4R', 'F5R', 'F6R'],
        'RE': ['F1RE', 'F2RE', 'F3RE', 'F4RE', 'F5RE', 'F6RE'],
        'AM': ['F1AM', 'F2AM', 'F3AM', 'F4AM', 'F5AM', 'F6AM']
      };

      const resultadosDimensiones = {};
      for (const [dim, facetas] of Object.entries(mapaDimensiones)) {
        const pdDim = facetas.reduce((sum, f) => sum + (pdFacetas[f] || 0), 0);
        const baremo = baremosDimensiones.find(b => b.codigo_dimension === dim && b.sexo === sexo && b.edad_desde <= edad && b.edad_hasta >= edad && b.pd_desde <= pdDim && b.pd_hasta >= pdDim);
        const percentil = baremo ? baremo.percentil : 'No encontrado';
        resultadosDimensiones[dim] = { PD: pdDim, Percentil: percentil };
      }

      testContainer.innerHTML = `
        <h2 id="question-text">¡Test completado!</h2>
        <div style="text-align:left; max-width:650px;">
          <h3>Facetas</h3>
          ${Object.entries(resultadosFacetas).sort((a,b) => a[0].localeCompare(b[0])).map(([f, r]) => `<p>${f}: PD=${r.PD}, Percentil=${r.Percentil}</p>`).join('')}
          <h3>Dimensiones</h3>
          ${Object.entries(resultadosDimensiones).sort((a,b) => a[0].localeCompare(b[0])).map(([d, r]) => `<p>${d}: PD=${r.PD}, Percentil=${r.Percentil}</p>`).join('')}
        </div>
      `;
      footer.style.display = 'none';
    }

    startBtn.onclick = startTest;
    prevBtn.onclick = () => {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuestion();
      }
    };
  </script>
</body>
</html>
